{"version":3,"file":"index.js","sources":["../src/createFetcher.js","../src/subscriptions.js","../src/createSubscriber.js","../src/isSubscribed.js"],"sourcesContent":["// @flow\n\nimport {observe, send} from \"@absinthe/socket\";\n\nimport type {AbsintheSocket} from \"@absinthe/socket\";\nimport type {FetchFunction} from \"react-relay\";\n\n/**\n * Creates a Fetcher (Relay FetchFunction) using the given AbsintheSocket\n * instance\n */\nconst createFetcher = (\n  absintheSocket: AbsintheSocket,\n  onError?: (error: Error) => any\n): FetchFunction => ({text: operation}, variables) =>\n  new Promise((resolve, reject) =>\n    // $FlowFixMe: operation is always defined\n    observe(absintheSocket, send(absintheSocket, {operation, variables}), {\n      onError,\n      onAbort: reject,\n      onResult: resolve\n    })\n  );\n\nexport default createFetcher;\n","// @flow\n\nimport type {Disposable} from \"react-relay\";\nimport type {Notifier} from \"@absinthe/socket\";\n\nconst subscriptions: WeakMap<\n  Disposable,\n  Promise<Notifier<any>>\n> = new WeakMap();\n\nexport default subscriptions;\n","// @flow\n\nimport notifierFind from \"@absinthe/socket/dist/notifier/find\";\nimport {observe, send, unobserveOrCancel} from \"@absinthe/socket\";\nimport {createDeferred} from \"@jumpn/utils-promise\";\nimport {getOperationType} from \"@jumpn/utils-graphql\";\n\nimport type {AbsintheSocket} from \"@absinthe/socket\";\nimport type {SubscribeFunction} from \"react-relay\";\n\nimport subscriptions from \"./subscriptions\";\n\nconst unobserveOrCancelIfNeeded = (absintheSocket, notifier, observer) => {\n  if (notifier) {\n    unobserveOrCancel(absintheSocket, notifier, observer);\n  }\n};\n\nconst createDisposable = (absintheSocket, {request}, observer) => ({\n  dispose: () =>\n    unobserveOrCancelIfNeeded(\n      absintheSocket,\n      notifierFind(absintheSocket.notifiers, \"request\", request),\n      observer\n    )\n});\n\nconst onStart = deferred => notifier => deferred.resolve(notifier);\n\nconst onAbort = (deferred, callback) => error => {\n  // callback is always defined but this is not correctly reflected in\n  // SubscribeFunction\n  callback && callback(error);\n\n  deferred.reject(error);\n};\n\n/**\n * Creates a Subscriber (Relay SubscribeFunction) using the given AbsintheSocket\n * instance\n */\nconst createSubscriber = (\n  absintheSocket: AbsintheSocket,\n  onRecoverableError?: (error: Error) => any\n): SubscribeFunction => (\n  {text: operation},\n  variables,\n  cacheConfig,\n  {onError: OnUnrecoverableError, onNext}\n) => {\n  // we need to place this logic here and not in ensureIsSubscription as if we\n  // do so, then flow is not able to infer we are validating operation\n  if (!operation || getOperationType(operation) !== \"subscription\") {\n    throw new Error(\n      `Expected subscription, but instead got:\\n${(operation: any)}`\n    );\n  }\n\n  const notifier = send(absintheSocket, {operation, variables});\n\n  const deferred = createDeferred();\n\n  const observer = {\n    onAbort: onAbort(deferred, OnUnrecoverableError),\n    onError: onRecoverableError,\n    onResult: (onNext: any),\n    onStart: onStart(deferred)\n  };\n\n  observe(absintheSocket, notifier, observer);\n\n  const disposable = createDisposable(absintheSocket, notifier, observer);\n\n  subscriptions.set(disposable, deferred.promise);\n\n  return disposable;\n};\n\nexport default createSubscriber;\n","// @flow\n\nimport {booleanize} from \"@jumpn/utils-promise\";\n\nimport type {Disposable} from \"react-relay\";\n\nimport subscriptions from \"./subscriptions\";\n\n/**\n * Returns a promise that resolves to `true` in case subscription of given\n * disposable has started or to `false` otherwise\n */\nconst isSubscribed = (disposable: Disposable): Promise<boolean> => {\n  const maybeSubscription = subscriptions.get(disposable);\n\n  return maybeSubscription\n    ? booleanize(maybeSubscription)\n    : Promise.resolve(false);\n};\n\nexport default isSubscribed;\n"],"names":["createFetcher","absintheSocket","onError","variables","operation","text","Promise","resolve","reject","observe","send","onAbort","onResult","subscriptions","WeakMap","unobserveOrCancelIfNeeded","notifier","observer","unobserveOrCancel","createDisposable","request","dispose","notifierFind","notifiers","onStart","deferred","callback","error","createSubscriber","onRecoverableError","cacheConfig","OnUnrecoverableError","onNext","getOperationType","Error","createDeferred","disposable","set","promise","isSubscribed","maybeSubscription","get","booleanize"],"mappings":"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"}